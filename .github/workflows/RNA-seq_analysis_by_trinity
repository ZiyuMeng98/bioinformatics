#IsoSeq3利用PacBio数据进行全长转录组分析
mkdir -p /home/mengziyu/working/08.RNA-seq_analysis_by_trinity/IsoSeq
cd IsoSeq
#将subreads转换成ccs数据
export PATH=/home/mengziyu/smrtlink/smrtcmds/bin/:$PATH
samtools view -h /home/train/00.incipient_data/data_for_gene_prediction_and_RNA-seq/m54086_170204_081430.subreads.bam | head -n 10000 | samtools view -b > m54086_170204_081430.subreads.bam
pbindex m54086_170204_081430.subreads.bam
ccs m54086_170204_081430.subreads.bam m54086_170204_081430.ccs.bam --min-passes 3 --min-rq 0.8
#去除引物和barcode碱基信息
echo '>NEB_5p 
GCAATGAAGTCGCAGGGTTGGG
>Clontech_5p
AAGCAGTGGTATCAACGCAGAGTACATGGGG
>NEB_Clontech_3p
GTACTCTGCGTTGATACCACTGCTT' > barcoded_primers.fasta
lima m54086_170204_081430.ccs.bam barcoded_primers.fasta m54086_170204_081430.lima.bam --isoseq --no-pbi --peek-guess
#安装isoseq3
conda install hcc::smrtlink-tools
"""
以下可能没用
conda update conda
conda create -n isoseq3  python=2.7 anaconda
conda activate isoseq3
conda install -n isoseq3 biopython
conda install -n isoseq3 -c http://conda.anaconda.org/cgat bx-python
conda install -n isoseq3 -c bioconda isoseq3
conda install -n isoseq3 -c bioconda bamtools  
conda install -n isoseq3 -c bioconda pysam
"""
#去除polyA和合体序列，得到FLNC序列
isoseq3 refine m54086_170204_081430*lima*.bam barcoded_primers.fasta m54086_170204_081430.flnc.bam --require-polya
#对FLNC reads进行聚类，得到全长转录本序列信息
isoseq3 cluster m54086_170204_081430.flnc.bam unpolished.bam --verbose
#对转录本进行修正
isoseq3 polish unpolished.bam m54086_170204_081430.subreads.bam polished.bam
#下一步应该转录本质量评估和转录本去冗余


#Trinity进行转录组de novo组装
mkdir -p /home/mengziyu/working/08.RNA-seq_analysis_by_trinity/trinity
cd trinity/
ln -s /home/train/00.incipient_data/data_for_gene_prediction_and_RNA-seq/*.fastq ./
#使用Trinity进行de novo组装，需要最少1.3版本的samtools conda install -c bioconda samtools=1.3
Trinity --left A.1.fastq,B.1.fastq,C.1.fastq,D.1.fastq,E.1.fastq,F.1.fastq,G.1.fastq --right A.2.fastq,B.2.fastq,C.2.fastq,D.2.fastq,E.2.fastq,F.2.fastq,G.2.fastq --seqType fq --max_memory 2G --SS_lib_type RF --CPU 32 --jaccard_clip --normalize_reads --output trinity_denovo --bflyCalculateCPU &> trinity_denovo.log
#统计Trinity组装结果
/opt/biosoft/Trinity-v2.11.0/util/TrinityStats.pl trinity_denovo/Trinity.fasta > trinity_denovo/Trinity.fasta.stats
#提取最长的Unigene
python3 extract_longest_isoforms_from_TrinityFasta.py trinity_denovo/Trinity.fasta > trinity_denovo/unigene.longest.fasta

#trinity进行有参转录组组装
samtools merge -@ 4 merged.bam /home/train/06.reads_aligment/hisat2/*.sam
#对bam文件进行排序，后续trinity有参组装
samtools sort -o sorted.merged.bam merged.bam
#对排序后文件构建索引
samtools index sorted.merged.bam
Trinity --max_memory 2G --SS_lib_type RF --CPU 16 --jaccard_clip --normalize_reads --genome_guided_bam merged.bam --genome_guided_max_intron 10000 --output trinity_genomeGuided --bflyCalculateCPU &> trinity_genomeGuided.log
