#IsoSeq3利用PacBio数据进行全长转录组分析
mkdir -p /home/mengziyu/working/08.RNA-seq_analysis_by_trinity/IsoSeq
cd IsoSeq
#将subreads转换成ccs数据
export PATH=/home/mengziyu/smrtlink/smrtcmds/bin/:$PATH
samtools view -h /home/train/00.incipient_data/data_for_gene_prediction_and_RNA-seq/m54086_170204_081430.subreads.bam | head -n 10000 | samtools view -b > m54086_170204_081430.subreads.bam
pbindex m54086_170204_081430.subreads.bam
ccs m54086_170204_081430.subreads.bam m54086_170204_081430.ccs.bam --min-passes 3 --min-rq 0.8
#去除引物和barcode碱基信息
echo '>NEB_5p 
GCAATGAAGTCGCAGGGTTGGG
>Clontech_5p
AAGCAGTGGTATCAACGCAGAGTACATGGGG
>NEB_Clontech_3p
GTACTCTGCGTTGATACCACTGCTT' > barcoded_primers.fasta
lima m54086_170204_081430.ccs.bam barcoded_primers.fasta m54086_170204_081430.lima.bam --isoseq --no-pbi --peek-guess
#安装isoseq3
conda install hcc::smrtlink-tools
"""
以下可能没用
conda update conda
conda create -n isoseq3  python=2.7 anaconda
conda activate isoseq3
conda install -n isoseq3 biopython
conda install -n isoseq3 -c http://conda.anaconda.org/cgat bx-python
conda install -n isoseq3 -c bioconda isoseq3
conda install -n isoseq3 -c bioconda bamtools  
conda install -n isoseq3 -c bioconda pysam
"""
#去除polyA和合体序列，得到FLNC序列
isoseq3 refine m54086_170204_081430*lima*.bam barcoded_primers.fasta m54086_170204_081430.flnc.bam --require-polya
#对FLNC reads进行聚类，得到全长转录本序列信息
isoseq3 cluster m54086_170204_081430.flnc.bam unpolished.bam --verbose
#对转录本进行修正
isoseq3 polish unpolished.bam m54086_170204_081430.subreads.bam polished.bam
#下一步应该转录本质量评估和转录本去冗余


#Trinity进行转录组de novo组装
mkdir -p /home/mengziyu/working/08.RNA-seq_analysis_by_trinity/trinity
cd trinity/
ln -s /home/train/00.incipient_data/data_for_gene_prediction_and_RNA-seq/*.fastq ./
#使用Trinity进行de novo组装，需要最少1.3版本的samtools conda install -c bioconda samtools=1.3
Trinity --left A.1.fastq,B.1.fastq,C.1.fastq,D.1.fastq,E.1.fastq,F.1.fastq,G.1.fastq --right A.2.fastq,B.2.fastq,C.2.fastq,D.2.fastq,E.2.fastq,F.2.fastq,G.2.fastq --seqType fq --max_memory 2G --SS_lib_type RF --CPU 32 --jaccard_clip --normalize_reads --output trinity_denovo --bflyCalculateCPU &> trinity_denovo.log
#统计Trinity组装结果
/opt/biosoft/Trinity-v2.11.0/util/TrinityStats.pl trinity_denovo/Trinity.fasta > trinity_denovo/Trinity.fasta.stats
#提取最长的Unigene
python3 extract_longest_isoforms_from_TrinityFasta.py trinity_denovo/Trinity.fasta > trinity_denovo/unigene.longest.fasta

#trinity进行有参转录组组装
samtools merge -@ 4 merged.bam /home/train/06.reads_aligment/hisat2/*.sam
#对bam文件进行排序，后续trinity有参组装
samtools sort -o sorted.merged.bam merged.bam
#对排序后文件构建索引
samtools index sorted.merged.bam
Trinity --max_memory 30G --SS_lib_type RF --CPU 16 --jaccard_clip --normalize_reads --genome_guided_bam sorted.merged.bam --genome_guided_max_intron 10000 --output trinity_genomeGuided --bflyCalculateCPU &> trinity_genomeGuided.log
/opt/biosoft/Trinity-v2.11.0/util/TrinityStats.pl trinity_genomeGuided/Trinity-GG.fasta > trinity_genomeGuided/Trinity-GG.fasta.stats


#基因差异表达分析
mkdir -p /home/mengziyu/working/08.RNA-seq_analysis_by_trinity/exp_cal
cd exp_cal
#准备转录组测序的索引文件
/opt/biosoft/Trinity-v2.11.0/util/align_and_estimate_abundance.pl --transcripts ../trinity_denovo/Trinity.fasta --est_method RSEM --aln_method bowtie --output_dir ./ --prep_reference
#进行表达量计算
sh command.align_and_estimate_abundance.sh
for file in */RSEM.isoforms.results; do
    sample=$(dirname "$file")
    cp "$file" "${sample}.isoforms.results"
done

#根据各个样品表达量，得到总的表达量矩阵，同时根据表达量去除假阳性序列
python3 extract_trinity_unigene_by_isofroms_expression_and_orf.py Trinity.fasta *.isoforms.results
#差异表达分析
mkdir -p /home/mengziyu/working/08.RNA-seq_analysis_by_trinity/diff_exp
cd /home/mengziyu/working/08.RNA-seq_analysis_by_trinity/diff_exp
#得到表达量matrix文件
ln -s ../exp_cal/out.gene_rawCounts.matrix gene.rawCount.matrix
ln -s ../exp_cal/out.gene_TPM.not_cross.matrix gene.TPM.not_cross.matrix
/opt/biosoft/Trinity-v2.11.0/util/support_scripts/run_TMM_scale_matrix.pl --matrix gene.TPM.not_cross.matrix > gen.TPM.TMM.matrix
#进行差异表达分析，注意左边AB为编组，右侧ABCDEF为样本名
echo -e "A\tA
A\tB
A/tC
B\tD
B\tE
B\tF
B\tG" > samples.txt
/opt/biosoft/Trinity-v2.11.0/Analysis/DifferentialExpression/run_DE_analysis.pl --matrix gene.rawCount.matrix --method DESeq2 --samples_file samples.txt --output DESeq2.genes.dir
"""
#如果上述命令显示内存不足， *** caught segfault ***
#                          address (nil), cause 'memory not mapped'
#输入如下
export R_MAX_VSIZE=32Gb
export R_MAX_NUM_DLLS=450
export R_MAX_MEM_SIZE=32Gb
export OMP_NUM_THREADS=2
export OPENBLAS_NUM_THREADS=2
export MKL_NUM_THREADS=2
"""
cd edgeR.genes.dir
/opt/biosoft/Trinity-v2.11.0/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix ../gene.TPM.not_cross.matrix -P 0.001 -C 2 --samples ../samples.txt
/opt/biosoft/Trinity-v2.11.0/Analysis/DifferentialExpression/analyze_diff_expr.pl --matrix ../gene.TPM.not_cross.matrix -P 0.01 -C 1 --samples ../samples.txt --order_columns_by_samples_file
#根据距离结果进行分类
#自动分类
/opt/biosoft/Trinity-v2.11.0/Analysis/DifferentialExpression/define_clusters_by_cutting_tree.pl --Ptree 80 -R diffExpr.P0.01_C1matrix.RData
"""
#手动分类
R
>load("diffExpr.P0.01_C1.matrix.RData")
>source("/opt/biosoft/Trinity-v2.11.0/Analysis/DifferentialExpression/R/manually_define_clusters.R")
>manually_define_clusters(hc_genes,data)
#然后左键点击选择子类，右键结束选择
#结果生成了文件夹manually_define_clusters_2，其中2表示手动分成了两类
cd manually_defined_clusters_2
#对每类结果进行趋势线的绘制
/opt/biosoft/Trinity-v2.11.0/Analysis/DifferentialExpression/plot_expression_patterns.pl cluster_*
